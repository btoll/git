#!/bin/bash

BLAME=false
BLOB_URL=https://github.com/extjs/SDK/blob/
BLAME_URL=https://github.com/extjs/SDK/blame/
COMMIT=
FILE=
HASH=
QUERY=
REMOTE_BRANCH=
URL=

usage() {
    echo "GIT-HUB"
    echo
    echo "Usage: $0 [args]"
    echo
    echo "Args:"
    echo "--blame, -blame       : If given will open the branch in the Blame view."
    echo "                        Not applicable if given a topic branch or hash."
    echo
    echo "--branch, -branch, -b : If given, will get the hash of the local topic branch."
    echo "                        Note that this should be thought of as the same as the"
    echo "                        hash option."
    echo
    echo "--file, -file, -f     : The file to lookup on GitHub. Accepts relative paths."
    echo
    echo "--hash, -hash, -h     : The commit hash to lookup on GitHub."
    echo
    echo "--remote, -remote, -r : The branch to use as the base lookup branch on GitHub."
    echo "                        Valid values are of the form 4.2.x, 4.2.3, 5.1.0, 6.0.0, etc."
    echo
    echo "--tag, -tag, -t       : It given, will get the hash of the tag."
    echo "                        Note that this should be thought of as the same as the"
    echo "                        hash option."
    echo
}

# Swap out for user-provided options if given.
while [ "$#" -gt 0 ]; do
    OPT="$1"
    case $OPT in
        --blame|-blame) BLAME=true ;;
        --branch|-branch|-b) shift; COMMIT=$1 ;;
        --file|-file|-f) shift; FILE=$1 ;;
        --hash|-hash|-h) shift; HASH=$1 ;;
        -help) usage; exit 0 ;;
        --remote|-remote|-r) shift; REMOTE_BRANCH=$1 ;;
        --tag|-tag|-t) shift; COMMIT=$1 ;;
    esac
    shift
done

if [[ ( -n "$HASH" ) || ( -n "$COMMIT" ) ]]; then
    # If given a topic branch or tag, simply get its hash.
    if [[ -n "$COMMIT" ]]; then
        HASH=$(git show "$COMMIT" | grep commit | awk '{print $2}')
    fi

    URL="https://github.com/extjs/SDK/commit/$HASH"
else
    QUERY=$(git rev-parse --show-prefix)

    if [ -n "$FILE" ]; then
        QUERY+="$FILE"
    fi

    if [[ -n "$REMOTE_BRANCH" ]]; then
        # Check the first character in the string.
        case  ${REMOTE_BRANCH:0:1} in
            4) REMOTE_BRANCH="extjs-$REMOTE_BRANCH" ;;
            *) REMOTE_BRANCH="sencha-$REMOTE_BRANCH" ;;
        esac
    else
        # Note that this will always default to the latest version.
        REMOTE_BRANCH="sencha-6.0.x"
    fi

    if $BLAME; then
        URL="$BLAME_URL$REMOTE_BRANCH/$QUERY"
    else
        URL="$BLOB_URL$REMOTE_BRANCH/$QUERY"
    fi
fi

echo "$URL"
open "$URL"

